name: Daily Finance Digest

on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

jobs:
  run-digest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install requests beautifulsoup4 matplotlib lxml

      - name: Run agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          mkdir -p logs data reports charts
          python main.py --mode run --days 1

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages

      - name: Send email with link
        run: |
          pip install resend
          python - <<'EOF'
          import resend
          import os
          resend.api_key = os.environ['RESEND_API_KEY']
          url = "https://mochenm7.github.io/paper-agent/latest.html"
          params = {
              "from": "Paper Agent <onboarding@resend.dev>",
              "to": "mamochen724@gmail.com",
              "subject": "Finance Digest - ä»Šæ—¥è®ºæ–‡å·²æ›´æ–°",
              "html": f"""
              <div style="font-family:sans-serif;max-width:600px;margin:0 auto;padding:20px;">
                <h2>ğŸ“š ä»Šæ—¥é‡‘èç ”ç©¶æ‘˜è¦å·²ç”Ÿæˆ</h2>
                <p>åŒ…å« NBERã€SSRNã€arXiv æœ€æ–°è®ºæ–‡ï¼Œå«åŒè¯­ AI åˆ†æå’Œäº’åŠ¨å¯¹è¯åŠŸèƒ½ã€‚</p>
                <a href="{url}" style="display:inline-block;background:#e94560;color:white;
                   padding:12px 24px;border-radius:8px;text-decoration:none;font-size:16px;">
                  ç‚¹å‡»æŸ¥çœ‹ä»Šæ—¥æŠ¥å‘Š
                </a>
                <p style="color:#888;font-size:12px;margin-top:20px;">
                  ç›´æ¥é“¾æ¥ï¼š{url}
                </p>
              </div>
              """,
          }
          resend.Emails.send(params)
          print("Email sent!")
          EOF
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
