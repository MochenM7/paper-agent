name: Daily Finance Digest

on:
  # GitHub Actions çš„ cron ç”¨ UTCã€‚å¸ƒæ‹‰æ ¼å†¬ä»¤æ—¶ UTC+1 / å¤ä»¤æ—¶ UTC+2ã€‚
  # ç”¨ 07:00 å’Œ 08:00 UTC éƒ½è§¦å‘ä¸€æ¬¡ï¼Œç„¶ååªåœ¨ Prague=09:xx æ—¶çœŸæ­£æ‰§è¡Œã€‚
  schedule:
    - cron: "0 7 * * *"
    - cron: "0 8 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-digest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          # å¦‚æœä½ åé¢ç”¨ RSSï¼Œéœ€è¦ feedparser
          pip install requests beautifulsoup4 matplotlib lxml google-genai resend feedparser

      - name: Run agent (only at 09:00 Prague)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          if [ "$(TZ=Europe/Prague date +%H)" != "09" ]; then
            echo "Skip: not 09:00 in Prague now."
            exit 0
          fi

          mkdir -p logs data reports charts
          python main.py --mode run --days 1

          # ç”Ÿæˆ latest.htmlï¼ˆå‘é“¾æ¥/Pages ç”¨è¿™ä¸ªï¼‰
          latest=$(ls -1t reports/*.html 2>/dev/null | head -n 1 || true)
          if [ -z "$latest" ]; then
            echo "ERROR: No HTML report generated in reports/."
            ls -lah reports || true
            exit 1
          fi
          echo "Latest report: $latest"
          cp "$latest" reports/latest.html

          # å¯é€‰ï¼šä¹Ÿç”Ÿæˆä¸€ä¸ª index.htmlï¼Œè®©æ‰“å¼€æ ¹ç›®å½•å°±èƒ½çœ‹åˆ°
          cp reports/latest.html reports/index.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages

      - name: Send email with link
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          python - <<'PY'
          import os
          import resend

          resend.api_key = os.environ["RESEND_API_KEY"]

          owner = os.environ["OWNER"].lower()
          repo = os.environ["REPO"]
          url = f"https://{owner}.github.io/{repo}/latest.html"

          params = {
              "from": "Paper Agent <onboarding@resend.dev>",
              "to": "mamochen724@gmail.com",
              "subject": "Finance Digest - ä»Šæ—¥è®ºæ–‡å·²æ›´æ–°",
              "html": f"""
              <div style="font-family:sans-serif;max-width:600px;margin:0 auto;padding:20px;">
                <h2>ğŸ“š ä»Šæ—¥é‡‘èç ”ç©¶æ‘˜è¦å·²ç”Ÿæˆ</h2>
                <p>ä»Šæ—¥æŠ¥å‘Šå·²å‘å¸ƒåˆ° GitHub Pagesã€‚</p>
                <a href="{url}" style="display:inline-block;background:#e94560;color:white;
                   padding:12px 24px;border-radius:8px;text-decoration:none;font-size:16px;">
                  ç‚¹å‡»æŸ¥çœ‹ä»Šæ—¥æŠ¥å‘Š
                </a>
                <p style="color:#888;font-size:12px;margin-top:20px;">
                  ç›´æ¥é“¾æ¥ï¼š{url}
                </p>
              </div>
              """,
          }

          resend.Emails.send(params)
          print("Email sent!", url)
          PY
