name: Daily Finance Digest

on:
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-digest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 matplotlib lxml google-genai resend

      - name: Run agent
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          mkdir -p logs data reports charts
          python main.py --mode run --days 1

          # ç”Ÿæˆ latest.htmlï¼ˆä½ å‘é“¾æ¥è¦ç”¨è¿™ä¸ªï¼‰
          # å‡è®¾ç¨‹åºè¾“å‡ºç±»ä¼¼ reports/digest_YYYY-MM-DD.html
          latest=$(ls -1t reports/*.html | head -n 1)
          echo "Latest report: $latest"
          cp "$latest" reports/latest.html

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages

      - name: Send email with link
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          python - <<'PY'
          import os
          import resend

          resend.api_key = os.environ["RESEND_API_KEY"]

          owner = os.environ["OWNER"].lower()
          repo = os.environ["REPO"]
          url = f"https://{owner}.github.io/{repo}/latest.html"

          params = {
              "from": "Paper Agent <onboarding@resend.dev>",
              "to": "mamochen724@gmail.com",
              "subject": "Finance Digest - ä»Šæ—¥è®ºæ–‡å·²æ›´æ–°",
              "html": f"""
              <div style="font-family:sans-serif;max-width:600px;margin:0 auto;padding:20px;">
                <h2>ğŸ“š ä»Šæ—¥é‡‘èç ”ç©¶æ‘˜è¦å·²ç”Ÿæˆ</h2>
                <p>åŒ…å« NBERã€SSRNã€arXiv æœ€æ–°è®ºæ–‡ï¼ˆå¦‚ SSRN è¢« 403 ä¼šè‡ªåŠ¨å°‘ä¸€äº›æ¥æºï¼‰ã€‚</p>
                <a href="{url}" style="display:inline-block;background:#e94560;color:white;
                   padding:12px 24px;border-radius:8px;text-decoration:none;font-size:16px;">
                  ç‚¹å‡»æŸ¥çœ‹ä»Šæ—¥æŠ¥å‘Š
                </a>
                <p style="color:#888;font-size:12px;margin-top:20px;">
                  ç›´æ¥é“¾æ¥ï¼š{url}
                </p>
              </div>
              """,
          }

          resend.Emails.send(params)
          print("Email sent!", url)
          PY
