name: Daily Finance Digest

on:
  schedule:
    - cron: '0 8 * * 3'    # å‘¨ä¸‰ UTC 8:00
    - cron: '0 8 * * 6'    # å‘¨å…­ UTC 8:00
  workflow_dispatch:

jobs:
  run-digest:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install requests beautifulsoup4 matplotlib lxml resend

      - name: Run agent
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          mkdir -p logs data reports charts
          python main.py --mode run --days 1

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./reports
          publish_branch: gh-pages

      - name: Send email
        run: |
          python - <<'EOF'
          import resend, os
          resend.api_key = os.environ['RESEND_API_KEY']
          url = "https://mochenm7.github.io/paper-agent/latest.html"
          resend.Emails.send({
              "from": "Paper Agent <onboarding@resend.dev>",
              "to":   "mamochen724@gmail.com",
              "subject": "ğŸ“š Finance Digest â€” today's papers ready",
              "html": f'<div style="font-family:sans-serif;padding:24px;background:#0d1117;color:#c9d1d9;border-radius:12px;"><h2 style="color:#f0f6fc;">ğŸ“š ä»Šæ—¥é‡‘èç ”ç©¶æ‘˜è¦</h2><p>NBER + SSRN + arXiv æœ€æ–°è®ºæ–‡ï¼ŒGemini AI åŒè¯­åˆ†æã€‚</p><a href="{url}" style="display:inline-block;background:#e94560;color:white;padding:12px 28px;border-radius:8px;text-decoration:none;font-size:16px;margin-top:12px;">ç‚¹å‡»æŸ¥çœ‹ä»Šæ—¥æŠ¥å‘Š â†’</a></div>'
          })
          print("Email sent!")
          EOF
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
